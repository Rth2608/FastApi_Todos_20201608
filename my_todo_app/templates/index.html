<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToDo App</title>
</head>
<body>
    {% if user %}
        <h2>환영합니다, {{ user.name }} 님!</h2>
        <a href="/logout"><button>로그아웃</button></a>

        <h3>당신의 ToDo 리스트</h3>
        <ul id="todo-list"></ul>

        <input type="text" id="new-todo" placeholder="할 일 추가">
        <button onclick="addTodo()">추가</button>
        <button onclick="saveTodos()">저장</button>

        <script>
        let todos = [];

        // 로그인한 사용자만 ToDo 불러오기
        fetch("/api/todos", {
            method: "GET",
            credentials: "include"
        })
        .then(res => {
            if (!res.ok) throw new Error("ToDo 불러오기 실패");
            return res.json();
        })
        .then(data => {
            todos = data;
            renderTodos();
        })
        .catch(err => {
            console.error(err);
            alert("ToDo 데이터를 불러올 수 없습니다.");
        });

        function renderTodos() {
            const list = document.getElementById("todo-list");
            list.innerHTML = "";
            todos.forEach((todo, index) => {
                const li = document.createElement("li");
                li.textContent = todo;
                list.appendChild(li);
            });
        }

        function addTodo() {
            const input = document.getElementById("new-todo");
            const value = input.value.trim();
            if (value) {
                todos.push(value);
                input.value = "";
                renderTodos();
            }
        }

        function saveTodos() {
            fetch("/api/todos", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify(todos)
            })
            .then(res => {
                if (!res.ok) throw new Error("저장 실패");
                return res.json();
            })
            .then(result => {
                alert("저장되었습니다!");
            })
            .catch(err => {
                console.error(err);
                alert("저장에 실패했습니다.");
            });
        }
        </script>

    {% else %}
        <h1>Google 로그인</h1>
        <a href="/login"><button>Google로 로그인</button></a>
    {% endif %}
</body>
</html>
